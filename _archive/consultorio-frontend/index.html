<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clínica Limale</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js' defer></script>
</head>
<body>
    <div class="main-app">
        <!-- MENU SUPERIOR (NAVBAR) -->
        <nav class="top-nav">
            <div class="logo">Clínica Limale</div>
            <a href="#dashboard" id="nav-dashboard">Dashboard</a>
            <a href="#pacientes" id="nav-pacientes">Pacientes</a>
            <a href="#agendamentos" id="nav-agendamentos">Agenda</a>
            <a href="#" id="logout-button" class="logout-button">Sair</a>
        </nav>

        <!-- ÁREA DE CONTEÚDO DINÂMICO -->
        <main id="app-content" class="content-area"></main>
    </div>

    <!-- MODAIS (FICAM FORA DA ÁREA DE CONTEÚDO PRINCIPAL) -->
    <div class="modal fade" id="pacienteModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="form-title-paciente"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="form-paciente">
                        <input type="hidden" id="paciente-id">
                        <div class="mb-3"><label for="nome" class="form-label">Nome Completo:</label><input type="text" id="nome" class="form-control" required></div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label for="cpf" class="form-label">CPF:</label><input type="text" id="cpf" class="form-control" required></div>
                            <div class="col-md-6 mb-3"><label for="data_nascimento" class="form-label">Data de Nascimento:</label><input type="date" id="data_nascimento" class="form-control" required></div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3"><label for="telefone_celular" class="form-label">Telefone:</label><input type="tel" id="telefone_celular" class="form-control"></div>
                            <div class="col-md-6 mb-3"><label for="medico-responsavel" class="form-label">Médico Responsável:</label><select id="medico-responsavel" class="form-select"></select></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" form="form-paciente">Salvar</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="agendamentoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 class="modal-title" id="form-title-agendamento"></h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <form id="form-agendamento">
                        <input type="hidden" id="agendamento-id">
                        <div class="mb-3"><label for="paciente-agendamento" class="form-label">Paciente:</label><select id="paciente-agendamento" class="form-select" required></select></div>
                        <div class="mb-3"><label for="data_hora_inicio" class="form-label">Início:</label><input type="datetime-local" id="data_hora_inicio" class="form-control" required></div>
                        <div class="mb-3"><label for="data_hora_fim" class="form-label">Fim:</label><input type="datetime-local" id="data_hora_fim" class="form-control" required></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="btn-deletar-agendamento" style="display: none;">Deletar</button>
                    <button type="submit" class="btn btn-primary" form="form-agendamento">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- 1. CONFIGURAÇÃO E SEGURANÇA ---
        const token = sessionStorage.getItem('authToken');
        if (!token) { window.location.href = 'login.html'; }
        const authHeaders = { 'Authorization': `Token ${token}`, 'Content-Type': 'application/json' };
        const contentArea = document.getElementById('app-content');
        const baseApiUrl = 'http://127.0.0.1:8000/api';

        // --- 2. FUNÇÕES DE RENDERIZAÇÃO ---

        async function renderDashboard() {
            contentArea.innerHTML = `
                <header class="header"><h1>Dashboard</h1></header>
                <section class="content-area">
                    <div class="row">
                        <div class="col-lg-3 col-md-6 mb-4"><div class="card text-center h-100"><div class="card-body"><h5>Agendados (Hoje)</h5><p class="h2" id="stat-agendados">...</p></div></div></div>
                        <div class="col-lg-3 col-md-6 mb-4"><div class="card text-center h-100"><div class="card-body"><h5>Confirmados</h5><p class="h2" id="stat-confirmados">...</p></div></div></div>
                        <div class="col-lg-3 col-md-6 mb-4"><div class="card text-center h-100"><div class="card-body"><h5>Realizados</h5><p class="h2" id="stat-realizados">...</p></div></div></div>
                        <div class="col-lg-3 col-md-6 mb-4"><div class="card text-center h-100"><div class="card-body"><h5>Cancelados</h5><p class="h2" id="stat-cancelados">...</p></div></div></div>
                    </div>
                    <div class="row">
                        <div class="col-lg-5"><div class="card"><div class="card-body">
                            <h2 class="card-title h5">Pacientes do Dia</h2>
                            <ul class="list-group list-group-flush" id="lista-pacientes-dia"><li class="list-group-item">Carregando...</li></ul>
                        </div></div></div>
                        <div class="col-lg-7"><div class="card"><div class="card-body">
                            <h2 class="card-title h5">Ações Rápidas</h2>
                            <p>Em breve, mais funcionalidades aqui.</p>
                        </div></div></div>
                    </div>
                </section>
            `;
            try {
                const statsResponse = await fetch(`${baseApiUrl}/dashboard-stats/`, { headers: authHeaders });
                const stats = await statsResponse.json();
                document.getElementById('stat-agendados').textContent = stats.total_agendados_dia;
                document.getElementById('stat-confirmados').textContent = stats.confirmados_dia;
                document.getElementById('stat-realizados').textContent = stats.realizados_dia;
                document.getElementById('stat-cancelados').textContent = stats.cancelados_dia;
                const hojeResponse = await fetch(`${baseApiUrl}/agendamentos-hoje/`, { headers: authHeaders });
                const agendamentosHoje = await hojeResponse.json();
                const listaPacientesDia = document.getElementById('lista-pacientes-dia');
                listaPacientesDia.innerHTML = '';
                if (agendamentosHoje.length === 0) {
                    listaPacientesDia.innerHTML = '<li class="list-group-item">Nenhum paciente agendado para hoje.</li>';
                } else {
                    agendamentosHoje.forEach(ag => {
                        const hora = new Date(ag.data_hora_inicio).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                        const listItem = document.createElement('li');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        listItem.innerHTML = `<span><strong>${hora}</strong> - ${ag.paciente}</span> <span class="badge bg-primary rounded-pill">${ag.status}</span>`;
                        listaPacientesDia.appendChild(listItem);
                    });
                }
            } catch (error) { console.error('Erro ao carregar dados do dashboard:', error); }
        }
        
        async function renderPacientes() {
            contentArea.innerHTML = `
                <header class="header">
                    <h1>Gestão de Pacientes</h1>
                    <button id="btn-novo-paciente" class="btn btn-primary">Cadastrar Novo Paciente</button>
                </header>
                <section class="content-area">
                    <div class="card">
                        <div class="card-body">
                            <h2 class="card-title">Lista de Pacientes</h2>
                            <table class="table table-hover">
                                <thead><tr><th>ID</th><th>Nome Completo</th><th>CPF</th><th class="text-end">Ações</th></tr></thead>
                                <tbody id="tabela-pacientes-corpo"></tbody>
                            </table>
                        </div>
                    </div>
                </section>
            `;
            
            const tabelaCorpo = document.getElementById('tabela-pacientes-corpo');
            const medicoSelect = document.getElementById('medico-responsavel');

            async function buscarPacientes() {
                try {
                    const response = await fetch(`${baseApiUrl}/pacientes/`, { headers: authHeaders });
                    const pacientes = await response.json();
                    tabelaCorpo.innerHTML = '';
                    pacientes.forEach(paciente => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${paciente.id}</td>
                            <td>${paciente.nome_completo}</td>
                            <td>${paciente.cpf}</td>
                            <td class="text-end">
                                <button class="btn btn-sm btn-info btn-prontuario" data-id="${paciente.id}">Prontuário</button>
                                <button class="btn btn-sm btn-warning btn-edit" data-id="${paciente.id}">Editar</button>
                                <button class="btn btn-sm btn-danger btn-delete" data-id="${paciente.id}">Deletar</button>
                            </td>
                        `;
                        tabelaCorpo.appendChild(tr);
                    });
                } catch (error) { console.error('Falha ao buscar pacientes:', error); }
            }

            async function carregarMedicos() {
                try {
                    const response = await fetch(`${baseApiUrl}/medicos/`, { headers: authHeaders });
                    const medicos = await response.json();
                    medicoSelect.innerHTML = '<option value="">-- Sem médico --</option>';
                    medicos.forEach(medico => {
                        const option = document.createElement('option');
                        option.value = medico.id;
                        const nomeCompleto = (medico.first_name && medico.last_name) ? `${medico.first_name} ${medico.last_name}` : medico.username;
                        option.textContent = nomeCompleto;
                        medicoSelect.appendChild(option);
                    });
                } catch (error) { console.error('Falha ao carregar médicos:', error); }
            }

            await carregarMedicos();
            await buscarPacientes();
        }
        
        async function renderAgendamentos() {
            contentArea.innerHTML = `
                <header class="header">
                    <h1>Agenda de Consultas</h1>
                    <button id="btn-novo-agendamento" class="btn btn-primary">Novo Agendamento</button>
                </header>
                <section class="content-area">
                    <div class="card"><div class="card-body"><div id='calendar'></div></div></div>
                </section>
            `;
            
            const calendarEl = document.getElementById('calendar');
            const pacienteSelect = document.getElementById('paciente-agendamento');
            
            async function carregarPacientesParaAgenda(selectedId = null) {
                try {
                    const response = await fetch(`${baseApiUrl}/pacientes/`, { headers: authHeaders });
                    const pacientes = await response.json();
                    pacienteSelect.innerHTML = '<option value="">Selecione um paciente</option>';
                    pacientes.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = p.nome_completo;
                        pacienteSelect.appendChild(option);
                    });
                    if (selectedId) pacienteSelect.value = selectedId;
                } catch (error) { console.error('Falha ao carregar pacientes:', error); }
            }

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'pt-br',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek' },
                events: (fetchInfo, successCallback, failureCallback) => {
                    fetch(`${baseApiUrl}/agendamentos/`, { headers: authHeaders })
                        .then(res => res.json())
                        .then(data => {
                            const eventos = data.map(ag => ({ id: ag.id, title: ag.paciente, start: ag.data_hora_inicio, end: ag.data_hora_fim, extendedProps: { pacienteId: ag.paciente } }));
                            successCallback(eventos);
                        })
                        .catch(err => failureCallback(err));
                },
                dateClick: function(info) {
                    const agendamentoModal = new bootstrap.Modal(document.getElementById('agendamentoModal'));
                    document.getElementById('form-agendamento').reset();
                    document.getElementById('agendamento-id').value = '';
                    document.getElementById('form-title-agendamento').textContent = 'Novo Agendamento';
                    document.getElementById('btn-deletar-agendamento').style.display = 'none';
                    document.getElementById('data_hora_inicio').value = `${info.dateStr}T09:00`;
                    document.getElementById('data_hora_fim').value = `${info.dateStr}T10:00`;
                    agendamentoModal.show();
                },
                eventClick: async function(info) {
                    const agendamentoModal = new bootstrap.Modal(document.getElementById('agendamentoModal'));
                    const id = info.event.id;
                    try {
                        const response = await fetch(`${baseApiUrl}/agendamentos/${id}/`, { headers: authHeaders });
                        const agendamento = await response.json();
                        
                        document.getElementById('agendamento-id').value = agendamento.id;
                        document.getElementById('form-title-agendamento').textContent = `Editando Agendamento`;
                        await carregarPacientesParaAgenda(agendamento.paciente);
                        document.getElementById('data_hora_inicio').value = new Date(agendamento.data_hora_inicio).toISOString().slice(0, 16);
                        document.getElementById('data_hora_fim').value = new Date(agendamento.data_hora_fim).toISOString().slice(0, 16);
                        
                        document.getElementById('btn-deletar-agendamento').style.display = 'inline-block';
                        agendamentoModal.show();
                    } catch (error) { console.error('Erro ao buscar agendamento:', error); }
                }
            });
            calendar.render();
            await carregarPacientesParaAgenda();
        }

        async function renderProntuario(pacienteId) {
            const pacienteDetailApiUrl = `${baseApiUrl}/pacientes/${pacienteId}/`;
            const evolucoesApiUrl = `${baseApiUrl}/pacientes/${pacienteId}/evolucoes/`;
            const prescricoesApiUrl = `${baseApiUrl}/pacientes/${pacienteId}/prescricoes/`;
            const anamneseApiUrl = `${baseApiUrl}/pacientes/${pacienteId}/anamnese/`;
            const atestadosApiUrl = `${baseApiUrl}/pacientes/${pacienteId}/atestados/`;

            contentArea.innerHTML = `
                <header class="header">
                    <h1 id="nome-paciente-prontuario">Carregando prontuário...</h1>
                    <button id="btn-voltar" class="btn btn-secondary">Voltar para a Lista de Pacientes</button>
                </header>
                <section class="content-area">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card mb-4"><div class="card-body" id="paciente-resumo"><h5 class="card-title">Carregando...</h5></div></div>
                            <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                                <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#v-pills-anamnese" type="button">Anamnese</button>
                                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#v-pills-evolucoes" type="button">Evoluções</button>
                                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#v-pills-prescricoes" type="button">Prescrições</button>
                                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#v-pills-atestados" type="button">Atestados</button>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="tab-content" id="v-pills-tabContent">
                                <div class="tab-pane fade show active" id="v-pills-anamnese" role="tabpanel"><div class="card"><div class="card-body">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h2 class="card-title">Anamnese</h2>
                                        <button id="btn-editar-anamnese" class="btn btn-sm btn-warning" style="display: none;">Editar</button>
                                    </div><hr><div id="anamnese-display"></div><form id="form-anamnese" style="display: none;"></form>
                                </div></div></div>
                                <div class="tab-pane fade" id="v-pills-evolucoes" role="tabpanel">
                                    <div class="card"><div class="card-body">
                                        <h2 class="card-title">Registrar Nova Evolução (SOAP)</h2>
                                        <form id="form-evolucao"><div class="mb-3"><label for="notas_subjetivas" class="form-label">Subjetivo (S):</label><textarea id="notas_subjetivas" class="form-control" required></textarea></div><div class="mb-3"><label for="notas_objetivas" class="form-label">Objetivo (O):</label><textarea id="notas_objetivas" class="form-control" required></textarea></div><div class="mb-3"><label for="avaliacao" class="form-label">Avaliação (A):</label><textarea id="avaliacao" class="form-control" required></textarea></div><div class="mb-3"><label for="plano" class="form-label">Plano (P):</label><textarea id="plano" class="form-control" required></textarea></div><button type="submit" class="btn btn-primary">Salvar Evolução</button></form>
                                    </div></div>
                                    <div class="card mt-4"><div class="card-body">
                                        <h2 class="card-title">Histórico de Evoluções</h2><div id="lista-evolucoes"></div>
                                    </div></div>
                                </div>
                                <div class="tab-pane fade" id="v-pills-prescricoes" role="tabpanel">
                                    <div class="card"><div class="card-body">
                                        <h2 class="card-title">Criar Nova Prescrição</h2>
                                        <form id="form-prescricao"><div id="medicamentos-container"></div><button type="button" id="add-medicamento-btn" class="btn btn-success">Adicionar Medicamento</button><hr><button type="submit" class="btn btn-primary">Salvar Prescrição</button></form>
                                    </div></div>
                                    <div class="card mt-4"><div class="card-body">
                                        <h2 class="card-title">Histórico de Prescrições</h2><div id="lista-prescricoes"></div>
                                    </div></div>
                                </div>
                                <div class="tab-pane fade" id="v-pills-atestados" role="tabpanel">
                                    <div class="card"><div class="card-body">
                                        <h2 class="card-title">Gerar Atestado</h2>
                                        <form id="form-atestado"><div class="mb-3"><label for="tipo_atestado" class="form-label">Tipo de Atestado:</label><select id="tipo_atestado" class="form-select" required><option value="" disabled selected>-- Selecione --</option><option value="Comparecimento">Comparecimento</option><option value="Afastamento">Afastamento</option><option value="Aptidao">Aptidão Física</option></select></div><div class="mb-3"><label for="observacoes" class="form-label">Texto:</label><textarea id="observacoes" class="form-control" rows="5" required></textarea></div><button type="submit" class="btn btn-primary">Gerar Atestado</button></form>
                                    </div></div>
                                    <div class="card mt-4"><div class="card-body">
                                        <h2 class="card-title">Histórico de Atestados</h2><div id="lista-atestados"></div>
                                    </div></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            `;
            
            let anamneseExistente = false;
            let dadosAnamneseCache = null;
            const camposAnamnesePadrao = ["Queixa Principal", "História da Doença Atual", "Histórico Médico Pregresso", "Histórico Familiar", "Alergias", "Medicamentos em Uso"];
            
            async function buscarDetalhesPaciente() {
                try {
                    const response = await fetch(pacienteDetailApiUrl, { headers: authHeaders });
                    const paciente = await response.json();
                    document.getElementById('nome-paciente-prontuario').textContent = `Prontuário de: ${paciente.nome_completo}`;
                    document.getElementById('paciente-resumo').innerHTML = `<h5 class="card-title">${paciente.nome_completo}</h5><p class="card-text text-muted">CPF: ${paciente.cpf}</p>`;
                } catch (error) { console.error('Erro ao buscar paciente:', error); }
            }

            async function buscarAnamnese() {
                const anamneseDisplay = document.getElementById('anamnese-display');
                const formAnamnese = document.getElementById('form-anamnese');
                const btnEditarAnamnese = document.getElementById('btn-editar-anamnese');
                try {
                    const response = await fetch(anamneseApiUrl, { headers: authHeaders });
                    if (response.status === 404) {
                        anamneseExistente = false;
                        btnEditarAnamnese.style.display = 'none';
                        renderizarFormularioAnamnese();
                        return;
                    }
                    const anamnese = await response.json();
                    dadosAnamneseCache = anamnese;
                    anamneseExistente = true;
                    renderizarDisplayAnamnese(anamnese);
                } catch (error) { console.error("Erro ao buscar anamnese:", error); }
            }

            function renderDisplayAnamnese(anamnese) {
                const formAnamnese = document.getElementById('form-anamnese');
                const anamneseDisplay = document.getElementById('anamnese-display');
                const btnEditarAnamnese = document.getElementById('btn-editar-anamnese');
                formAnamnese.style.display = 'none';
                btnEditarAnamnese.style.display = 'block';
                const dataAtt = new Date(anamnese.data_atualizacao).toLocaleString('pt-BR');
                let camposHtml = `<div class="anamnese-meta"><strong>Última atualização:</strong> ${dataAtt} | <strong>Médico:</strong> ${anamnese.medico}</div>`;
                camposAnamnesePadrao.forEach(campo => {
                    const chave = campo.toLowerCase().replace(/\s+/g, '_');
                    camposHtml += `<div class="campo-anamnese"><strong>${campo}:</strong><p>${(anamnese[chave] || '').replace(/\n/g, '<br>') || '(Não informado)'}</p></div>`;
                });
                anamneseDisplay.innerHTML = camposHtml;
                anamneseDisplay.style.display = 'block';
            }

            function renderizarFormularioAnamnese(dados = {}) {
                const anamneseDisplay = document.getElementById('anamnese-display');
                const formAnamnese = document.getElementById('form-anamnese');
                const btnEditarAnamnese = document.getElementById('btn-editar-anamnese');
                anamneseDisplay.style.display = 'none';
                btnEditarAnamnese.style.display = 'none';
                let camposHtml = '';
                camposAnamnesePadrao.forEach(campo => {
                    const chave = campo.toLowerCase().replace(/\s+/g, '_');
                    const valor = dados[chave] || '';
                    camposHtml += `<div class="mb-3"><label class="form-label">${campo}:</label><textarea id="${chave}" class="form-control">${valor}</textarea></div>`;
                });
                formAnamnese.innerHTML = camposHtml + '<button type="submit" class="btn btn-primary mt-3">Salvar Anamnese</button>';
                formAnamnese.style.display = 'block';
            }

            async function buscarEvolucoes() {
                const listaEvolucoesElement = document.getElementById('lista-evolucoes');
                try {
                    const response = await fetch(evolucoesApiUrl, { headers: authHeaders });
                    const evolucoes = await response.json();
                    listaEvolucoesElement.innerHTML = '';
                    if (evolucoes.length === 0) {
                        listaEvolucoesElement.innerHTML = '<p>Nenhum registro de evolução encontrado.</p>';
                    } else {
                        evolucoes.forEach(evo => {
                            const dataAtendimento = new Date(evo.data_atendimento).toLocaleString('pt-BR');
                            const divEvolucao = document.createElement('div');
                            divEvolucao.classList.add('evolucao');
                            divEvolucao.innerHTML = `<div class="evolucao-meta"><strong>Data:</strong> ${dataAtendimento} | <strong>Médico:</strong> ${evo.medico}</div><p><strong>S:</strong> ${evo.notas_subjetivas}</p><p><strong>O:</strong> ${evo.notas_objetivas}</p><p><strong>A:</strong> ${evo.avaliacao}</p><p><strong>P:</strong> ${evo.plano}</p>`;
                            listaEvolucoesElement.appendChild(divEvolucao);
                        });
                    }
                } catch (error) { listaEvolucoesElement.innerHTML = '<p>Erro ao carregar histórico de evoluções.</p>'; }
            }

            async function buscarPrescricoes() {
                const listaPrescricoesElement = document.getElementById('lista-prescricoes');
                try {
                    const response = await fetch(prescricoesApiUrl, { headers: authHeaders });
                    const prescricoes = await response.json();
                    listaPrescricoesElement.innerHTML = '';
                    if (prescricoes.length === 0) {
                        listaPrescricoesElement.innerHTML = '<p>Nenhuma prescrição encontrada.</p>';
                    } else {
                        prescricoes.forEach(prescricao => {
                            const dataPrescricao = new Date(prescricao.data_prescricao).toLocaleString('pt-BR');
                            let itensHtml = '';
                            prescricao.itens.forEach(item => {
                                itensHtml += `<li class="prescricao-item">${item.medicamento} (${item.dosagem}) - ${item.instrucoes}</li>`;
                            });
                            const divPrescricao = document.createElement('div');
                            divPrescricao.classList.add('prescricao');
                            divPrescricao.innerHTML = `<div class="prescricao-meta"><strong>Data:</strong> ${dataPrescricao} | <strong>Médico:</strong> ${prescricao.medico}</div><ul>${itensHtml}</ul>`;
                            listaPrescricoesElement.appendChild(divPrescricao);
                        });
                    }
                } catch (error) { listaPrescricoesElement.innerHTML = '<p>Erro ao carregar histórico de prescrições.</p>'; }
            }

            function adicionarMedicamento() {
                const medicamentosContainer = document.getElementById('medicamentos-container');
                const itemIndex = medicamentosContainer.children.length;
                const divMedicamento = document.createElement('div');
                divMedicamento.classList.add('medicamento-item');
                divMedicamento.innerHTML = `<h5>Medicamento ${itemIndex + 1}</h5><div class="mb-2"><label class="form-label">Medicamento:</label><input type="text" class="form-control medicamento-nome" required></div><div class="mb-2"><label class="form-label">Dosagem:</label><input type="text" class="form-control medicamento-dosagem" required></div><div class="mb-2"><label class="form-label">Instruções:</label><textarea class="form-control medicamento-instrucoes" required></textarea></div>`;
                medicamentosContainer.appendChild(divMedicamento);
            }

            async function buscarAtestados() {
                const listaAtestados = document.getElementById('lista-atestados');
                try {
                    const response = await fetch(atestadosApiUrl, { headers: authHeaders });
                    const atestados = await response.json();
                    listaAtestados.innerHTML = '';
                    if (atestados.length === 0) {
                        listaAtestados.innerHTML = '<p>Nenhum atestado emitido.</p>';
                    } else {
                        atestados.forEach(atestado => {
                            const dataEmissao = new Date(atestado.data_emissao).toLocaleString('pt-BR');
                            const divAtestado = document.createElement('div');
                            divAtestado.classList.add('evolucao');
                            divAtestado.innerHTML = `<div class="evolucao-meta"><strong>Data:</strong> ${dataEmissao} | <strong>Médico:</strong> ${atestado.medico}</div><p><strong>Tipo:</strong> ${atestado.tipo_atestado_display}</p><p><strong>Texto:</strong><br>${atestado.observacoes.replace(/\n/g, '<br>')}</p>`;
                            listaAtestados.appendChild(divAtestado);
                        });
                    }
                } catch (error) { listaAtestados.innerHTML = '<p>Erro ao carregar atestados.</p>'; }
            }
            
            await Promise.all([
                buscarDetalhesPaciente(),
                buscarAnamnese(),
                buscarEvolucoes(),
                buscarPrescricoes(),
                buscarAtestados()
            ]);
            adicionarMedicamento();
        }

        // --- 3. EVENT LISTENERS GLOBAIS (DELEGAÇÃO) ---
        
        document.body.addEventListener('click', async (event) => {
            const target = event.target;

            if (target.id === 'logout-button') {
                sessionStorage.removeItem('authToken');
                window.location.href = 'login.html';
            }
            if (target.id === 'btn-novo-paciente') {
                const form = document.getElementById('form-paciente');
                if(form) {
                    form.reset();
                    document.getElementById('paciente-id').value = '';
                    document.getElementById('form-title-paciente').textContent = 'Cadastrar Novo Paciente';
                    new bootstrap.Modal(document.getElementById('pacienteModal')).show();
                }
            }
            if (target.classList.contains('btn-prontuario')) {
                window.location.hash = `#prontuario/${target.dataset.id}`;
            }
            if (target.classList.contains('btn-edit')) {
                const id = target.dataset.id;
                const form = document.getElementById('form-paciente');
                if(form) {
                    form.reset();
                    const response = await fetch(`${baseApiUrl}/pacientes/${id}/`, { headers: authHeaders });
                    const paciente = await response.json();
                    document.getElementById('form-title-paciente').textContent = `Editando Paciente: ${paciente.nome_completo}`;
                    document.getElementById('paciente-id').value = paciente.id;
                    document.getElementById('nome').value = paciente.nome_completo;
                    document.getElementById('cpf').value = paciente.cpf;
                    document.getElementById('data_nascimento').value = paciente.data_nascimento;
                    document.getElementById('telefone_celular').value = paciente.telefone_celular;
                    document.getElementById('medico-responsavel').value = paciente.medico_responsavel;
                    new bootstrap.Modal(document.getElementById('pacienteModal')).show();
                }
            }
            if (target.classList.contains('btn-delete')) {
                if (confirm(`Tem certeza que deseja deletar o paciente?`)) {
                    await fetch(`${baseApiUrl}/pacientes/${target.dataset.id}/`, { method: 'DELETE', headers: authHeaders });
                    router();
                }
            }
            if (target.id === 'btn-novo-agendamento') {
                const form = document.getElementById('form-agendamento');
                if(form) {
                    form.reset();
                    document.getElementById('agendamento-id').value = '';
                    document.getElementById('form-title-agendamento').textContent = 'Novo Agendamento';
                    document.getElementById('btn-deletar-agendamento').style.display = 'none';
                    new bootstrap.Modal(document.getElementById('agendamentoModal')).show();
                }
            }
            if (target.id === 'btn-deletar-agendamento') {
                const id = document.getElementById('agendamento-id').value;
                if (id && confirm('Tem certeza?')) {
                    await fetch(`${baseApiUrl}/agendamentos/${id}/`, { method: 'DELETE', headers: authHeaders });
                    bootstrap.Modal.getInstance(document.getElementById('agendamentoModal')).hide();
                    router();
                }
            }
            if (target.id === 'btn-editar-anamnese') {
                renderizarFormularioAnamnese(window.dadosAnamneseCache);
            }
            if (target.id === 'add-medicamento-btn') {
                adicionarMedicamento();
            }
        });

        document.body.addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.target;

            if (form.id === 'form-paciente') {
                const id = document.getElementById('paciente-id').value;
                const pacienteData = {
                    nome_completo: document.getElementById('nome').value,
                    cpf: document.getElementById('cpf').value,
                    data_nascimento: document.getElementById('data_nascimento').value,
                    telefone_celular: document.getElementById('telefone_celular').value,
                    medico_responsavel: document.getElementById('medico-responsavel').value || null
                };
                const url = id ? `${baseApiUrl}/pacientes/${id}/` : `${baseApiUrl}/pacientes/`;
                const method = id ? 'PUT' : 'POST';
                await fetch(url, { method, headers: authHeaders, body: JSON.stringify(pacienteData) });
                bootstrap.Modal.getInstance(document.getElementById('pacienteModal')).hide();
                router();
            }

            if (form.id === 'form-agendamento') {
                const id = document.getElementById('agendamento-id').value;
                const agendamentoData = {
                    paciente: document.getElementById('paciente-agendamento').value,
                    data_hora_inicio: document.getElementById('data_hora_inicio').value,
                    data_hora_fim: document.getElementById('data_hora_fim').value,
                };
                const url = id ? `${baseApiUrl}/agendamentos/${id}/` : `${baseApiUrl}/agendamentos/`;
                const method = id ? 'PUT' : 'POST';
                await fetch(url, { method, headers: authHeaders, body: JSON.stringify(agendamentoData) });
                bootstrap.Modal.getInstance(document.getElementById('agendamentoModal')).hide();
                router();
            }

            if (form.id === 'form-anamnese') {
                const anamneseData = {
                    queixa_principal: document.getElementById('queixa_principal').value,
                    historia_doenca_atual: document.getElementById('historia_doenca_atual').value,
                    historico_medico_pregresso: document.getElementById('historico_medico_pregresso').value,
                    historico_familiar: document.getElementById('historico_familiar').value,
                    alergias: document.getElementById('alergias').value,
                    medicamentos_em_uso: document.getElementById('medicamentos_em_uso').value,
                };
                const method = window.anamneseExistente ? 'PUT' : 'POST';
                await fetch(`${baseApiUrl}/pacientes/${window.location.hash.split('/')[1]}/anamnese/`, { method, headers: authHeaders, body: JSON.stringify(anamneseData) });
                alert('Anamnese salva com sucesso!');
                router();
            }
            if (form.id === 'form-evolucao') {
                const evolucaoData = {
                    paciente_id: window.location.hash.split('/')[1],
                    notas_subjetivas: document.getElementById('notas_subjetivas').value,
                    notas_objetivas: document.getElementById('notas_objetivas').value,
                    avaliacao: document.getElementById('avaliacao').value,
                    plano: document.getElementById('plano').value,
                };
                await fetch(`${baseApiUrl}/pacientes/${window.location.hash.split('/')[1]}/evolucoes/`, { method: 'POST', headers: authHeaders, body: JSON.stringify(evolucaoData) });
                form.reset();
                router();
            }
            if (form.id === 'form-prescricao') {
                const itens = [];
                form.querySelectorAll('.medicamento-item').forEach(item => {
                    const nome = item.querySelector('.medicamento-nome').value;
                    if(nome) {
                        itens.push({
                            medicamento: nome,
                            dosagem: item.querySelector('.medicamento-dosagem').value,
                            instrucoes: item.querySelector('.medicamento-instrucoes').value,
                        });
                    }
                });
                if (itens.length === 0) { alert('Adicione pelo menos um medicamento.'); return; }
                await fetch(`${baseApiUrl}/pacientes/${window.location.hash.split('/')[1]}/prescricoes/`, { method: 'POST', headers: authHeaders, body: JSON.stringify({ itens }) });
                alert('Prescrição salva com sucesso!');
                router();
            }
            if (form.id === 'form-atestado') {
                const atestadoData = {
                    tipo_atestado: document.getElementById('tipo_atestado').value,
                    observacoes: document.getElementById('observacoes').value,
                };
                if (!atestadoData.tipo_atestado) { alert('Selecione um tipo de atestado.'); return; }
                await fetch(`${baseApiUrl}/pacientes/${window.location.hash.split('/')[1]}/atestados/`, { method: 'POST', headers: authHeaders, body: JSON.stringify(atestadoData) });
                alert('Atestado gerado com sucesso!');
                form.reset();
                router();
            }
        });

        function router() {
            const path = window.location.hash || '#dashboard';
            const [route, param] = path.split('/');
            
            document.querySelectorAll('.top-nav a').forEach(link => link.classList.remove('active'));
            const activeLinkBase = (route === '#prontuario') ? '#pacientes' : route;
            const activeLink = document.querySelector(`.top-nav a[href="${activeLinkBase}"]`);
            if (activeLink) activeLink.classList.add('active');

            if (route === '#dashboard') { renderDashboard(); } 
            else if (route === '#pacientes') { renderPacientes(); } 
            else if (route === '#agendamentos') { renderAgendamentos(); }
            else if (route === '#prontuario' && param) { renderProntuario(param); }
            else { renderDashboard(); }
        }
        
        window.addEventListener('hashchange', router);
        
        // --- 4. INICIALIZAÇÃO ---
        router();
    </script>
</body>
</html>
