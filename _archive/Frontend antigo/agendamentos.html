<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda - Clínica Limale</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>
</head>
<body>
    <nav class="sidebar-nav">
    <a href="dashboard.html">Dashboard</a> <a href="index.html">Gestão de Pacientes</a>
    <a href="agendamentos.html">Gestão de Agendamentos</a>
    <a href="#" id="logout-button" class="logout-link">Sair</a>
    </nav>
    </aside>

    <main class="main-content">
        <header class="header">
            <h1>Agenda de Consultas</h1>
            <button id="btn-novo-agendamento" class="btn btn-primary">Novo Agendamento</button>
        </header>

        <section class="content-area">
            <div class="card">
                <div class="card-body">
                    <div id='calendar'></div>
                </div>
            </div>
        </section>
    </main>

    <div class="modal fade" id="agendamentoModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="form-title">Novo Agendamento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="form-agendamento">
                        <input type="hidden" id="agendamento-id">
                        <div class="mb-3">
                            <label for="paciente" class="form-label">Paciente:</label>
                            <select id="paciente" class="form-select" required></select>
                        </div>
                        <div class="mb-3">
                            <label for="data_hora_inicio" class="form-label">Início:</label>
                            <input type="datetime-local" id="data_hora_inicio" class="form-control" required>
                        </div>
                        <div class="mb-3">
                            <label for="data_hora_fim" class="form-label">Fim:</label>
                            <input type="datetime-local" id="data_hora_fim" class="form-control" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" id="btn-deletar-agendamento" style="display: none;">Deletar</button>
                    <button type="submit" class="btn btn-primary" id="submit-button" form="form-agendamento">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const token = localStorage.getItem('authToken');
        if (!token) { window.location.href = 'login.html'; }
        const authHeaders = { 'Authorization': `Token ${token}`, 'Content-Type': 'application/json' };

        const agendamentoApiUrl = 'http://127.0.0.1:8000/api/agendamentos/';
        const pacienteApiUrl = 'http://127.0.0.1:8000/api/pacientes/';

        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            const agendamentoModal = new bootstrap.Modal(document.getElementById('agendamentoModal'));
            const formAgendamento = document.getElementById('form-agendamento');
            const pacienteSelect = document.getElementById('paciente');
            const agendamentoIdInput = document.getElementById('agendamento-id');
            const formTitle = document.getElementById('form-title');
            const btnDeletar = document.getElementById('btn-deletar-agendamento');
            
            // Lógica para carregar pacientes no dropdown
            async function carregarPacientes(selectedId = null) {
                try {
                    const response = await fetch(pacienteApiUrl, { headers: authHeaders });
                    const pacientes = await response.json();
                    pacienteSelect.innerHTML = '<option value="">Selecione um paciente</option>';
                    pacientes.forEach(p => {
                        const option = document.createElement('option');
                        option.value = p.id;
                        option.textContent = p.nome_completo;
                        pacienteSelect.appendChild(option);
                    });
                    if (selectedId) {
                        pacienteSelect.value = selectedId;
                    }
                } catch (error) { console.error('Falha ao carregar pacientes:', error); }
            }

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'pt-br',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                events: (fetchInfo, successCallback, failureCallback) => {
                    fetch(agendamentoApiUrl, { headers: { 'Authorization': `Token ${token}` } })
                        .then(res => res.json())
                        .then(data => {
                            const eventos = data.map(ag => ({
                                id: ag.id,
                                title: ag.paciente,
                                start: ag.data_hora_inicio,
                                end: ag.data_hora_fim,
                                extendedProps: { pacienteId: ag.paciente_id } // Guardamos a ID do paciente
                            }));
                            successCallback(eventos);
                        })
                        .catch(err => failureCallback(err));
                },
                // Ação ao clicar em um dia no calendário
                dateClick: function(info) {
                    formAgendamento.reset();
                    agendamentoIdInput.value = '';
                    formTitle.textContent = 'Novo Agendamento';
                    btnDeletar.style.display = 'none';
                    document.getElementById('data_hora_inicio').value = `${info.dateStr}T09:00`;
                    document.getElementById('data_hora_fim').value = `${info.dateStr}T10:00`;
                    agendamentoModal.show();
                },
                // Ação ao clicar em um evento (agendamento) existente
                eventClick: async function(info) {
                    const id = info.event.id;
                    try {
                        const response = await fetch(`${agendamentoApiUrl}${id}/`, { headers: { 'Authorization': `Token ${token}` } });
                        const agendamento = await response.json();
                        
                        agendamentoIdInput.value = agendamento.id;
                        formTitle.textContent = `Editando Agendamento`;
                        await carregarPacientes(agendamento.paciente); // Carrega pacientes e seleciona o correto
                        document.getElementById('data_hora_inicio').value = new Date(agendamento.data_hora_inicio).toISOString().slice(0, 16);
                        document.getElementById('data_hora_fim').value = new Date(agendamento.data_hora_fim).toISOString().slice(0, 16);
                        
                        btnDeletar.style.display = 'inline-block';
                        agendamentoModal.show();
                    } catch (error) { console.error('Erro ao buscar agendamento:', error); }
                }
            });

            calendar.render();

            // Abre modal para novo agendamento via botão
            document.getElementById('btn-novo-agendamento').addEventListener('click', () => {
                formAgendamento.reset();
                agendamentoIdInput.value = '';
                formTitle.textContent = 'Novo Agendamento';
                btnDeletar.style.display = 'none';
                agendamentoModal.show();
            });

            // Lógica para salvar (Criar/Editar)
            formAgendamento.addEventListener('submit', async (event) => {
                event.preventDefault();
                const id = agendamentoIdInput.value;
                const isEditing = id !== '';
                const agendamentoData = {
                    paciente: pacienteSelect.value,
                    data_hora_inicio: document.getElementById('data_hora_inicio').value,
                    data_hora_fim: document.getElementById('data_hora_fim').value,
                };
                const url = isEditing ? `${agendamentoApiUrl}${id}/` : agendamentoApiUrl;
                const method = isEditing ? 'PUT' : 'POST';
                
                try {
                    await fetch(url, { method, headers: authHeaders, body: JSON.stringify(agendamentoData) });
                    agendamentoModal.hide();
                    calendar.refetchEvents();
                } catch(error) { console.error('Erro ao salvar agendamento:', error); }
            });

            // Lógica para deletar
            btnDeletar.addEventListener('click', async () => {
                const id = agendamentoIdInput.value;
                if (id && confirm('Tem certeza que deseja deletar este agendamento?')) {
                    try {
                        await fetch(`${agendamentoApiUrl}${id}/`, { method: 'DELETE', headers: authHeaders });
                        agendamentoModal.hide();
                        calendar.refetchEvents();
                    } catch(error) { console.error('Erro ao deletar:', error); }
                }
            });

            // Lógica de Logout
            document.getElementById('logout-button').addEventListener('click', () => {
                localStorage.removeItem('authToken');
                window.location.href = 'login.html';
            });

            // Inicializa a página
            carregarPacientes();
        });
    </script>
</body>
</html>