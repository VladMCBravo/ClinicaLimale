<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Consultório</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav>
        <a href="index.html">Gestão de Pacientes</a>
        <a href="agendamentos.html">Gestão de Agendamentos</a>
    </nav>
    <h1>Painel do Consultório</h1>

    <h2 id="form-title">Cadastrar Novo Paciente</h2>
    <form id="form-paciente">
        <input type="hidden" id="paciente-id"> <div>
            <label for="nome">Nome Completo:</label>
            <input type="text" id="nome" required>
        </div>
        <div>
            <label for="cpf">CPF:</label>
            <input type="text" id="cpf" required>
        </div>
        <div>
            <label for="data_nascimento">Data de Nascimento:</label>
            <input type="date" id="data_nascimento" required>
        </div>
        <div>
            <label for="telefone_celular">Telefone:</label>
            <input type="tel" id="telefone_celular">
        </div>
        <button type="submit" id="submit-button">Criar Paciente</button>
        <button type="button" id="cancel-button" style="display:none;">Cancelar Edição</button>
    </form>

    <h2>Lista de Pacientes</h2>
    <ul id="lista-pacientes"></ul>

    <script>
        const apiUrl = 'http://127.0.0.1:8000/api/pacientes/';
        const listaPacientesElement = document.getElementById('lista-pacientes');
        const formPaciente = document.getElementById('form-paciente');
        const pacienteIdInput = document.getElementById('paciente-id');
        const formTitle = document.getElementById('form-title');
        const submitButton = document.getElementById('submit-button');
        const cancelButton = document.getElementById('cancel-button');

        // --- LÓGICA PARA LISTAR PACIENTES (MODIFICADA) ---
        async function buscarPacientes() {
            // ... (código de busca igual, mas a criação dos itens muda)
            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`Erro de rede: ${response.status}`);
                const pacientes = await response.json();
                
                listaPacientesElement.innerHTML = '';
                pacientes.forEach(paciente => {
                    const listItem = document.createElement('li');
                    const textoPaciente = document.createElement('span');
                    textoPaciente.textContent = `ID: ${paciente.id} | Nome: ${paciente.nome_completo}`;
                    listItem.appendChild(textoPaciente);
                    
                    const actionsDiv = document.createElement('div');
                    actionsDiv.classList.add('actions');

                    const editButton = document.createElement('button');
                    editButton.textContent = 'Editar';
                    editButton.classList.add('btn-edit');
                    editButton.dataset.id = paciente.id;
                    actionsDiv.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Deletar';
                    deleteButton.classList.add('btn-delete');
                    deleteButton.dataset.id = paciente.id;
                    actionsDiv.appendChild(deleteButton);
                    
                    listItem.appendChild(actionsDiv);
                    listaPacientesElement.appendChild(listItem);
                });
            } catch (error) {
                console.error('Falha ao buscar pacientes:', error);
                listaPacientesElement.innerHTML = '<li>Erro ao carregar os dados.</li>';
            }
        }

// --- LÓGICA DO FORMULÁRIO (CRIAR E ATUALIZAR) ---
        formPaciente.addEventListener('submit', async (event) => {
            event.preventDefault();
            const pacienteData = {
                nome_completo: document.getElementById('nome').value,
                cpf: document.getElementById('cpf').value,
                data_nascimento: document.getElementById('data_nascimento').value,
                telefone_celular: document.getElementById('telefone_celular').value,
            };

            const id = pacienteIdInput.value;
            const isEditing = id !== '';
            const url = isEditing ? `${apiUrl}${id}/` : apiUrl;
            const method = isEditing ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json',},
                    body: JSON.stringify(pacienteData)
                });
                if (!response.ok) throw new Error(`Erro na operação: ${response.status}`);
                
                alert(`Paciente ${isEditing ? 'atualizado' : 'criado'} com sucesso!`);
                resetForm();
                buscarPacientes();
            } catch (error) {
                console.error('Falha ao criar paciente:', error);
                alert('Erro ao criar paciente. Verifique o console para mais detalhes.');
            }
        });

  // --- LÓGICA DO FORMULÁRIO (CRIAR E ATUALIZAR) ---
        formPaciente.addEventListener('submit', async (event) => {
            event.preventDefault();
            const pacienteData = {
                nome_completo: document.getElementById('nome').value,
                cpf: document.getElementById('cpf').value,
                data_nascimento: document.getElementById('data_nascimento').value,
                telefone_celular: document.getElementById('telefone_celular').value,
            };

            const id = pacienteIdInput.value;
            const isEditing = id !== '';
            const url = isEditing ? `${apiUrl}${id}/` : apiUrl;
            const method = isEditing ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json',},
                    body: JSON.stringify(pacienteData)
                });
                if (!response.ok) throw new Error(`Erro na operação: ${response.status}`);
                
                alert(`Paciente ${isEditing ? 'atualizado' : 'criado'} com sucesso!`);
                resetForm();
                buscarPacientes();
            } catch (error) { /* ... (código de erro igual) ... */ }
        });

        // --- LÓGICA PARA ENTRAR NO MODO DE EDIÇÃO OU DELETAR ---
        listaPacientesElement.addEventListener('click', async (event) => {
            const target = event.target;
            const id = target.dataset.id;

            if (target.classList.contains('btn-edit')) {
                // MODO EDIÇÃO
                try {
                    const response = await fetch(`${apiUrl}${id}/`);
                    if (!response.ok) throw new Error('Paciente não encontrado');
                    const paciente = await response.json();

                    formTitle.textContent = 'Editando Paciente';
                    pacienteIdInput.value = paciente.id;
                    document.getElementById('nome').value = paciente.nome_completo;
                    document.getElementById('cpf').value = paciente.cpf;
                    document.getElementById('data_nascimento').value = paciente.data_nascimento;
                    document.getElementById('telefone_celular').value = paciente.telefone_celular;
                    
                    submitButton.textContent = 'Salvar Alterações';
                    cancelButton.style.display = 'inline-block';
                    window.scrollTo(0, 0); // Rola a página para o topo
                } catch (error) { alert('Erro ao carregar dados para edição.'); }
            }

            if (target.classList.contains('btn-delete')) {
                // MODO DELEÇÃO
                if (confirm(`Tem certeza que deseja deletar o paciente com ID ${id}?`)) {
                    try {
                        const response = await fetch(`${apiUrl}${id}/`, { method: 'DELETE' });
                        if (!response.ok) throw new Error('Erro ao deletar');
                        alert('Paciente deletado com sucesso!');
                        buscarPacientes();
                    } catch (error) { alert('Falha ao deletar paciente.'); }
                }
            }
        });
        
        // --- LÓGICA PARA CANCELAR A EDIÇÃO ---
        function resetForm() {
            formPaciente.reset();
            pacienteIdInput.value = '';
            formTitle.textContent = 'Cadastrar Novo Paciente';
            submitButton.textContent = 'Criar Paciente';
            cancelButton.style.display = 'none';
        }
        cancelButton.addEventListener('click', resetForm);

        // --- CHAMADA INICIAL ---
        buscarPacientes();
    </script>

</body>
</html>