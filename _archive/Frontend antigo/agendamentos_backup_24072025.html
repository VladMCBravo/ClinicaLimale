<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel do Consultório - Agendamentos</title>
    <style>
        /* ... (os mesmos estilos que já temos) ... */
        body { font-family: system-ui, sans-serif; padding: 2em; background-color: #f8f9fa; color: #333; max-width: 800px; margin: auto; }
        h1, h2 { color: #343a40; border-bottom: 2px solid #dee2e6; padding-bottom: 10px;}
        nav { background-color: #e9ecef; padding: 10px; border-radius: 8px; margin-bottom: 2em; }
        nav a { margin-right: 15px; font-weight: bold; color: #007bff; text-decoration: none; }
        ul { list-style-type: none; padding: 0; }
        li { display: flex; justify-content: space-between; align-items: center; background-color: #fff; margin-bottom: 8px; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .actions button { margin-left: 5px; }
        form { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-top: 20px; }
        form div { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select { width: 98%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        button { background-color: #007bff; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; }
        button:hover { background-color: #0056b3; }
        .btn-delete { background-color: #dc3545; }
        .btn-delete:hover { background-color: #c82333; }
        .btn-edit { background-color: #ffc107; color: black; }
        .btn-edit:hover { background-color: #e0a800; }
    </style>
</head>
<body>
    <nav>
        <a href="index.html">Gestão de Pacientes</a>
        <a href="agendamentos.html">Gestão de Agendamentos</a>
    </nav>
    
    <h1>Gestão de Agendamentos</h1>

    <h2 id="form-title">Novo Agendamento</h2>
    <form id="form-agendamento">
        <input type="hidden" id="agendamento-id">
        <div>
            <label for="paciente">Paciente:</label>
            <select id="paciente" required></select>
        </div>
        <div>
            <label for="data_hora_inicio">Início:</label>
            <input type="datetime-local" id="data_hora_inicio" required>
        </div>
        <div>
            <label for="data_hora_fim">Fim:</label>
            <input type="datetime-local" id="data_hora_fim" required>
        </div>
        <button type="submit" id="submit-button">Criar Agendamento</button>
        <button type="button" id="cancel-button" style="display:none;">Cancelar Edição</button>
    </form>

    <h2>Próximos Agendamentos</h2>
    <ul id="lista-agendamentos"></ul>

    <script>
        const agendamentoApiUrl = 'http://127.0.0.1:8000/api/agendamentos/';
        const pacienteApiUrl = 'http://127.0.0.1:8000/api/pacientes/';

        // --- REFERÊNCIAS AOS ELEMENTOS DO HTML ---
        const listaAgendamentosElement = document.getElementById('lista-agendamentos');
        const formAgendamento = document.getElementById('form-agendamento');
        const pacienteSelect = document.getElementById('paciente');
        const agendamentoIdInput = document.getElementById('agendamento-id');
        const formTitle = document.getElementById('form-title');
        const submitButton = document.getElementById('submit-button');
        const cancelButton = document.getElementById('cancel-button');

        // --- FUNÇÕES PRINCIPAIS ---

        // Carrega pacientes no menu <select>
        async function carregarPacientes() { /* ... código sem alteração ... */ }

        // Busca e exibe a lista de agendamentos (com botões)
        async function buscarAgendamentos() {
            try {
                const response = await fetch(agendamentoApiUrl);
                const agendamentos = await response.json();
                listaAgendamentosElement.innerHTML = '';
                agendamentos.forEach(agendamento => {
                    const listItem = document.createElement('li');
                    const textoAgendamento = document.createElement('span');
                    const dataInicio = new Date(agendamento.data_hora_inicio);
                    const dataFormatada = dataInicio.toLocaleString('pt-BR', {dateStyle: 'short', timeStyle: 'short'});
                    textoAgendamento.textContent = `Paciente: ${agendamento.paciente} | Início: ${dataFormatada}`;
                    listItem.appendChild(textoAgendamento);

                    const actionsDiv = document.createElement('div');
                    actionsDiv.classList.add('actions');
                    const editButton = document.createElement('button');
                    editButton.textContent = 'Editar';
                    editButton.classList.add('btn-edit');
                    editButton.dataset.id = agendamento.id;
                    actionsDiv.appendChild(editButton);
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Deletar';
                    deleteButton.classList.add('btn-delete');
                    deleteButton.dataset.id = agendamento.id;
                    actionsDiv.appendChild(deleteButton);
                    
                    listItem.appendChild(actionsDiv);
                    listaAgendamentosElement.appendChild(listItem);
                });
            } catch (error) { console.error('Falha ao buscar agendamentos:', error); }
        }

        // Reseta o formulário para o modo de criação
        function resetForm() {
            formAgendamento.reset();
            agendamentoIdInput.value = '';
            formTitle.textContent = 'Novo Agendamento';
            submitButton.textContent = 'Criar Agendamento';
            cancelButton.style.display = 'none';
        }

        // --- EVENT LISTENERS ---

        // Lida com o envio do formulário (Criar ou Atualizar)
        formAgendamento.addEventListener('submit', async (event) => {
            event.preventDefault();
            const id = agendamentoIdInput.value;
            const isEditing = id !== '';
            const agendamentoData = {
                paciente: pacienteSelect.value,
                data_hora_inicio: document.getElementById('data_hora_inicio').value,
                data_hora_fim: document.getElementById('data_hora_fim').value,
            };

            const url = isEditing ? `${agendamentoApiUrl}${id}/` : agendamentoApiUrl;
            const method = isEditing ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(agendamentoData)
                });
                if (!response.ok) throw new Error(`Falha na operação: ${response.status}`);
                alert(`Agendamento ${isEditing ? 'atualizado' : 'criado'} com sucesso!`);
                resetForm();
                buscarAgendamentos();
            } catch (error) { console.error('Erro:', error); alert('Ocorreu um erro.'); }
        });

        // Lida com cliques nos botões de Editar ou Deletar
        listaAgendamentosElement.addEventListener('click', async (event) => {
            const target = event.target;
            const id = target.dataset.id;
            if (!id) return;

            if (target.classList.contains('btn-edit')) {
                try {
                    const response = await fetch(`${agendamentoApiUrl}${id}/`);
                    const agendamento = await response.json();
                    
                    formTitle.textContent = 'Editando Agendamento';
                    agendamentoIdInput.value = agendamento.id;
                    pacienteSelect.value = agendamento.paciente; // Nota: isso funciona se a API de detalhe retornar a ID do paciente
                    // Formata a data para o input datetime-local (YYYY-MM-DDTHH:MM)
                    document.getElementById('data_hora_inicio').value = new Date(agendamento.data_hora_inicio).toISOString().slice(0, 16);
                    document.getElementById('data_hora_fim').value = new Date(agendamento.data_hora_fim).toISOString().slice(0, 16);
                    
                    submitButton.textContent = 'Salvar Alterações';
                    cancelButton.style.display = 'inline-block';
                    window.scrollTo(0, 0);
                } catch (error) { console.error('Erro ao buscar agendamento:', error); }
            }

            if (target.classList.contains('btn-delete')) {
                if (confirm('Tem certeza que deseja deletar este agendamento?')) {
                    try {
                        await fetch(`${agendamentoApiUrl}${id}/`, { method: 'DELETE' });
                        alert('Agendamento deletado com sucesso!');
                        buscarAgendamentos();
                    } catch (error) { console.error('Erro ao deletar:', error); }
                }
            }
        });

        // Cancela a edição
        cancelButton.addEventListener('click', resetForm);

        // --- INICIALIZAÇÃO DA PÁGINA ---
        async function init() {
            await carregarPacientes();
            await buscarAgendamentos();
        }
        init();

        // Implementação da função carregarPacientes
        async function carregarPacientes() {
            try {
                const response = await fetch(pacienteApiUrl);
                const pacientes = await response.json();
                pacienteSelect.innerHTML = '<option value="">Selecione um paciente</option>';
                pacientes.forEach(paciente => {
                    const option = document.createElement('option');
                    option.value = paciente.id;
                    option.textContent = paciente.nome_completo;
                    pacienteSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Falha ao carregar pacientes:', error);
                pacienteSelect.innerHTML = '<option value="">Erro ao carregar pacientes</option>';
            }
        }
    </script>
</body>
</html>