<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pacientes - Clínica Limale</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <aside class="sidebar">
        <div class="sidebar-header">Clínica Limale</div>
        <nav class="sidebar-nav">
            <a href="dashboard.html">Dashboard</a>
            <a href="index.html" class="active">Gestão de Pacientes</a>
            <a href="agendamentos.html">Gestão de Agendamentos</a>
            <a href="#" id="logout-button" class="logout-link">Sair</a>
        </nav>
    </aside>

    <main class="main-content">
        <header class="header">
            <h1>Gestão de Pacientes</h1>
            <button id="btn-novo-paciente" class="btn btn-primary">Cadastrar Novo Paciente</button>
        </header>

        <section class="content-area">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">Lista de Pacientes</h2>
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nome Completo</th>
                                <th>CPF</th>
                                <th class="text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-pacientes-corpo"></tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <div class="modal fade" id="pacienteModal" tabindex="-1">
         </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    const token = localStorage.getItem('authToken');
    if (!token) { window.location.href = 'login.html'; }
    const authHeaders = {
        'Authorization': `Token ${token}`,
        'Content-Type': 'application/json'
    };

    const apiUrl = 'http://127.0.0.1:8000/api/pacientes/';
    const medicosApiUrl = 'http://127.0.0.1:8000/api/medicos/';

    const tabelaCorpo = document.getElementById('tabela-pacientes-corpo');
    const formPaciente = document.getElementById('form-paciente');
    const pacienteIdInput = document.getElementById('paciente-id');
    const medicoSelect = document.getElementById('medico-responsavel');
    const formTitle = document.getElementById('form-title');
    const submitButton = document.getElementById('submit-button');
    const btnNovoPaciente = document.getElementById('btn-novo-paciente');
    const pacienteModal = new bootstrap.Modal(document.getElementById('pacienteModal'));

    // --- FUNÇÕES ---
    async function buscarPacientes() {
        try {
            const response = await fetch(apiUrl, { headers: { 'Authorization': `Token ${token}` } });
            if (response.status === 401) { window.location.href = 'login.html'; return; }
            const pacientes = await response.json();
            
            tabelaCorpo.innerHTML = '';
            pacientes.forEach(paciente => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${paciente.id}</td>
                    <td>${paciente.nome_completo}</td>
                    <td>${paciente.cpf}</td>
                    <td class="text-end">
                        <a href="prontuario.html?id=${paciente.id}" class="btn btn-sm btn-info">Prontuário</a>
                        <button class="btn btn-sm btn-warning btn-edit" data-id="${paciente.id}">Editar</button>
                        <button class="btn btn-sm btn-danger btn-delete" data-id="${paciente.id}">Deletar</button>
                    </td>
                `;
                tabelaCorpo.appendChild(tr);
            });
        } catch (error) { console.error('Falha ao buscar pacientes:', error); }
    }

    // --- FUNÇÃO QUE ESTAVA FALTANDO ---
    async function carregarMedicos() {
        try {
            const response = await fetch(medicosApiUrl, { headers: authHeaders });
            const medicos = await response.json();
            medicoSelect.innerHTML = '<option value="">-- Sem médico --</option>';
            medicos.forEach(medico => {
                const option = document.createElement('option');
                option.value = medico.id;
                const nomeCompleto = (medico.first_name && medico.last_name) ? `${medico.first_name} ${medico.last_name}` : medico.username;
                option.textContent = nomeCompleto;
                medicoSelect.appendChild(option);
            });
        } catch (error) {
            console.error('Falha ao carregar médicos:', error);
        }
    }

    function resetForm() {
        formPaciente.reset();
        pacienteIdInput.value = '';
        formTitle.textContent = 'Cadastrar Novo Paciente';
        submitButton.textContent = 'Salvar';
    }

    // --- EVENT LISTENERS ---
    btnNovoPaciente.addEventListener('click', () => {
        resetForm();
        pacienteModal.show();
    });

    tabelaCorpo.addEventListener('click', async (event) => {
        const target = event.target;
        const id = target.dataset.id;
        if (!id) return;

        if (target.classList.contains('btn-edit')) {
            resetForm();
            try {
                const response = await fetch(`${apiUrl}${id}/`, { headers: { 'Authorization': `Token ${token}` } });
                const paciente = await response.json();
                
                formTitle.textContent = `Editando Paciente: ${paciente.nome_completo}`;
                pacienteIdInput.value = paciente.id;
                document.getElementById('nome').value = paciente.nome_completo;
                document.getElementById('cpf').value = paciente.cpf;
                document.getElementById('data_nascimento').value = paciente.data_nascimento;
                document.getElementById('telefone_celular').value = paciente.telefone_celular;
                medicoSelect.value = paciente.medico_responsavel;
                
                pacienteModal.show();
            } catch (error) { console.error('Erro ao carregar paciente:', error); }
        }

        if (target.classList.contains('btn-delete')) {
            if (confirm(`Tem certeza que deseja deletar o paciente?`)) {
                try {
                    await fetch(`${apiUrl}${id}/`, { method: 'DELETE', headers: { 'Authorization': `Token ${token}` } });
                    buscarPacientes();
                } catch (error) { console.error('Falha ao deletar:', error); }
            }
        }
    });

    formPaciente.addEventListener('submit', async (event) => {
        event.preventDefault();
        const pacienteData = {
            nome_completo: document.getElementById('nome').value,
            cpf: document.getElementById('cpf').value,
            data_nascimento: document.getElementById('data_nascimento').value,
            telefone_celular: document.getElementById('telefone_celular').value,
            medico_responsavel: medicoSelect.value || null
        };
        const id = pacienteIdInput.value;
        const isEditing = id !== '';
        const url = isEditing ? `${apiUrl}${id}/` : apiUrl;
        const method = isEditing ? 'PUT' : 'POST';

        try {
            const response = await fetch(url, { method, headers: authHeaders, body: JSON.stringify(pacienteData) });
            if (!response.ok) throw new Error('Falha ao salvar');
            pacienteModal.hide();
            buscarPacientes();
        } catch (error) { console.error('Erro ao salvar paciente:', error); }
    });

    document.getElementById('logout-button').addEventListener('click', () => {
        localStorage.removeItem('authToken');
        window.location.href = 'login.html';
    });

    async function init() {
        await carregarMedicos();
        await buscarPacientes();
    }
    
    init();
</script>
</body>
</html>