<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prontuário - Clínica Limale</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <nav class="sidebar-nav">
    <a href="dashboard.html">Dashboard</a> <a href="index.html">Gestão de Pacientes</a>
    <a href="agendamentos.html">Gestão de Agendamentos</a>
    <a href="#" id="logout-button" class="logout-link">Sair</a>
    </nav>
    </aside>

    <main class="main-content">
        <header class="header">
            <h1 id="nome-paciente">Carregando prontuário...</h1>
        </header>

        <section class="content-area">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <h2 class="card-title">Anamnese</h2>
                        <button id="btn-editar-anamnese" class="btn btn-sm btn-warning" style="display: none;">Editar</button>
                    </div>
                    <div id="anamnese-display"></div>
                    <form id="form-anamnese" style="display: none;"></form>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">Registrar Nova Evolução (SOAP)</h2>
                    <form id="form-evolucao">
                        <div class="mb-3"><label for="notas_subjetivas" class="form-label">Subjetivo (S):</label><textarea id="notas_subjetivas" class="form-control" required></textarea></div>
                        <div class="mb-3"><label for="notas_objetivas" class="form-label">Objetivo (O):</label><textarea id="notas_objetivas" class="form-control" required></textarea></div>
                        <div class="mb-3"><label for="avaliacao" class="form-label">Avaliação (A):</label><textarea id="avaliacao" class="form-control" required></textarea></div>
                        <div class="mb-3"><label for="plano" class="form-label">Plano (P):</label><textarea id="plano" class="form-control" required></textarea></div>
                        <button type="submit" class="btn btn-primary">Salvar Evolução</button>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">Histórico de Evoluções</h2>
                    <div id="lista-evolucoes"></div>
                </div>
            </div>

            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">Criar Nova Prescrição</h2>
                    <form id="form-prescricao">
                        <div id="medicamentos-container"></div>
                        <button type="button" id="add-medicamento-btn" class="btn btn-success">Adicionar Medicamento</button>
                        <hr>
                        <button type="submit" class="btn btn-primary">Salvar Prescrição</button>
                    </form>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">Histórico de Prescrições</h2>
                    <div id="lista-prescricoes"></div>
                </div>
            </div>
             <section class="content-area">
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">Anamnese</h2>
                    <div id="anamnese-display"></div>
                    <form id="form-anamnese" style="display: none;"></form>
                </div>
            </div>
                <div class="card">
                <div class="card-body">
                    <h2 class="card-title">Gerar Atestado</h2>
                    <form id="form-atestado">
                        <div class="mb-3">
                            <label for="tipo_atestado" class="form-label">Tipo de Atestado:</label>
                            <select id="tipo_atestado" class="form-select" required>
                                <option value="" disabled selected>-- Selecione o tipo --</option>
                                <option value="Comparecimento">Atestado de Comparecimento</option>
                                <option value="Afastamento">Atestado de Afastamento</option>
                                <option value="Aptidao">Atestado de Aptidão Física</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="observacoes" class="form-label">Texto / Observações:</label>
                            <textarea id="observacoes" class="form-control" rows="5" placeholder="Atesto para os devidos fins que o(a) paciente esteve em consulta nesta data..." required></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">Gerar Atestado</button>
                    </form>
                </div>
            </div>
            <div class="card">
                <div class="card-body">
                    <h2 class="card-title">Histórico de Atestados</h2>
                    <div id="lista-atestados"></div>
                </div>
            </div>
            </section>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- 1. SEGURANÇA E CONFIGURAÇÃO ---
        const token = localStorage.getItem('authToken');
        if (!token) { window.location.href = 'login.html'; }
        const authHeaders = { 'Content-Type': 'application/json', 'Authorization': `Token ${token}` };
        const urlParams = new URLSearchParams(window.location.search);
        const pacienteId = urlParams.get('id');
        if (!pacienteId) { window.location.href = 'index.html'; }

        // URLs da API
        const pacienteDetailApiUrl = `http://127.0.0.1:8000/api/pacientes/${pacienteId}/`;
        const atestadosApiUrl = `http://127.0.0.1:8000/api/pacientes/${pacienteId}/atestados/`;
        const evolucoesApiUrl = `http://127.0.0.1:8000/api/pacientes/${pacienteId}/evolucoes/`;
        const prescricoesApiUrl = `http://127.0.0.1:8000/api/pacientes/${pacienteId}/prescricoes/`;
        const anamneseApiUrl = `http://127.0.0.1:8000/api/pacientes/${pacienteId}/anamnese/`;
        
        // Referências aos Elementos
        const nomePacienteElement = document.getElementById('nome-paciente');
        const formAtestado = document.getElementById('form-atestado');
        const listaAtestados = document.getElementById('lista-atestados');
        const formAnamnese = document.getElementById('form-anamnese');
        const anamneseDisplay = document.getElementById('anamnese-display');
        const btnEditarAnamnese = document.getElementById('btn-editar-anamnese');
        const formEvolucao = document.getElementById('form-evolucao');
        const listaEvolucoesElement = document.getElementById('lista-evolucoes');
        const formPrescricao = document.getElementById('form-prescricao');
        const listaPrescricoesElement = document.getElementById('lista-prescricoes');
        const medicamentosContainer = document.getElementById('medicamentos-container');
        const addMedicamentoBtn = document.getElementById('add-medicamento-btn');
        
        let anamneseExistente = false;
        let dadosAnamneseCache = null;
        const camposAnamnesePadrao = ["Queixa Principal", "História da Doença Atual", "Histórico Médico Pregresso", "Histórico Familiar", "Alergias", "Medicamentos em Uso"];
        
        // --- 2. DEFINIÇÃO DE FUNÇÕES ---

        async function buscarDetalhesPaciente() {
            try {
                const response = await fetch(pacienteDetailApiUrl, { headers: authHeaders });
                if (response.status === 401) { window.location.href = 'login.html'; return; }
                if (!response.ok) throw new Error('Paciente não encontrado');
                const paciente = await response.json();
                nomePacienteElement.textContent = `Prontuário de: ${paciente.nome_completo}`;
            } catch (error) {
                console.error('Erro ao buscar paciente:', error);
                nomePacienteElement.textContent = 'Erro ao Carregar Paciente';
            }
        }

        async function buscarAnamnese() {
            try {
                const response = await fetch(anamneseApiUrl, { headers: authHeaders });
                if (response.status === 404) {
                    anamneseExistente = false;
                    btnEditarAnamnese.style.display = 'none';
                    renderizarFormularioAnamnese();
                    return;
                }
                if (!response.ok) throw new Error('Falha ao buscar anamnese');
                const anamnese = await response.json();
                dadosAnamneseCache = anamnese;
                anamneseExistente = true;
                renderizarDisplayAnamnese(anamnese);
            } catch (error) {
                console.error("Erro ao buscar anamnese:", error);
                anamneseDisplay.innerHTML = "Erro ao carregar anamnese."
            }
        }

        function renderizarDisplayAnamnese(anamnese) {
            formAnamnese.style.display = 'none';
            btnEditarAnamnese.style.display = 'block';
            const dataAtt = new Date(anamnese.data_atualizacao).toLocaleString('pt-BR');
            let camposHtml = `<div class="anamnese-meta"><strong>Última atualização:</strong> ${dataAtt} | <strong>Médico:</strong> ${anamnese.medico}</div>`;
            anamnese.campos.forEach(campo => {
                camposHtml += `<div class="campo-anamnese"><strong>${campo.campo}:</strong><p>${(campo.valor || '').replace(/\n/g, '<br>') || '(Não informado)'}</p></div>`;
            });
            anamneseDisplay.innerHTML = camposHtml;
            anamneseDisplay.style.display = 'block';
        }
        
        function renderizarFormularioAnamnese(dadosCache = null) {
            anamneseDisplay.style.display = 'none';
            btnEditarAnamnese.style.display = 'none';
            let camposHtml = '';
            const dadosValores = {};
            if (dadosCache) {
                dadosCache.campos.forEach(c => { dadosValores[c.campo] = c.valor; });
            }
            camposAnamnesePadrao.forEach(campo => {
                const valor = dadosValores[campo] || '';
                camposHtml += `<div class="mb-3"><label class="form-label">${campo}:</label><textarea class="form-control" data-campo-nome="${campo}">${valor}</textarea></div>`;
            });
            formAnamnese.innerHTML = camposHtml + '<button type="submit" class="btn btn-primary mt-3">Salvar Anamnese</button>';
            formAnamnese.style.display = 'block';
        }
        
        async function buscarEvolucoes() {
            try {
                const response = await fetch(evolucoesApiUrl, { headers: authHeaders });
                if (!response.ok) throw new Error('Falha ao buscar evoluções');
                const evolucoes = await response.json();
                listaEvolucoesElement.innerHTML = '';
                if (evolucoes.length === 0) {
                    listaEvolucoesElement.innerHTML = '<p>Nenhum registro de evolução encontrado.</p>';
                } else {
                    evolucoes.forEach(evo => {
                        const dataAtendimento = new Date(evo.data_atendimento).toLocaleString('pt-BR');
                        const divEvolucao = document.createElement('div');
                        divEvolucao.classList.add('evolucao');
                        divEvolucao.innerHTML = `<div class="evolucao-meta"><strong>Data:</strong> ${dataAtendimento} | <strong>Médico:</strong> ${evo.medico}</div><p><strong>S:</strong> ${evo.notas_subjetivas}</p><p><strong>O:</strong> ${evo.notas_objetivas}</p><p><strong>A:</strong> ${evo.avaliacao}</p><p><strong>P:</strong> ${evo.plano}</p>`;
                        listaEvolucoesElement.appendChild(divEvolucao);
                    });
                }
            } catch (error) {
                console.error('Erro ao buscar evoluções:', error);
                listaEvolucoesElement.innerHTML = '<p>Erro ao carregar histórico de evoluções.</p>';
            }
        }
        
        async function buscarPrescricoes() {
            try {
                const response = await fetch(prescricoesApiUrl, { headers: authHeaders });
                if (!response.ok) throw new Error('Falha ao buscar prescrições');
                const prescricoes = await response.json();
                listaPrescricoesElement.innerHTML = '';
                if (prescricoes.length === 0) {
                    listaPrescricoesElement.innerHTML = '<p>Nenhuma prescrição encontrada.</p>';
                } else {
                    prescricoes.forEach(prescricao => {
                        const dataPrescricao = new Date(prescricao.data_prescricao).toLocaleString('pt-BR');
                        let itensHtml = '';
                        prescricao.itens.forEach(item => {
                            itensHtml += `<li class="prescricao-item">${item.medicamento} (${item.dosagem}) - ${item.instrucoes}</li>`;
                        });
                        const divPrescricao = document.createElement('div');
                        divPrescricao.classList.add('prescricao');
                        divPrescricao.innerHTML = `<div class="prescricao-meta"><strong>Data:</strong> ${dataPrescricao} | <strong>Médico:</strong> ${prescricao.medico}</div><ul>${itensHtml}</ul>`;
                        listaPrescricoesElement.appendChild(divPrescricao);
                    });
                }
            } catch (error) {
                console.error('Erro ao buscar prescrições:', error);
                listaPrescricoesElement.innerHTML = '<p>Erro ao carregar histórico de prescrições.</p>';
            }
        }

        function adicionarMedicamento() {
            const itemIndex = medicamentosContainer.children.length;
            const divMedicamento = document.createElement('div');
            divMedicamento.classList.add('medicamento-item');
            divMedicamento.innerHTML = `<h5>Medicamento ${itemIndex + 1}</h5><div class="mb-2"><label class="form-label">Medicamento:</label><input type="text" class="form-control medicamento-nome" required></div><div class="mb-2"><label class="form-label">Dosagem:</label><input type="text" class="form-control medicamento-dosagem" required></div><div class="mb-2"><label class="form-label">Instruções:</label><textarea class="form-control medicamento-instrucoes" required></textarea></div>`;
            medicamentosContainer.appendChild(divMedicamento);
        }
         async function buscarAtestados() {
            try {
                const response = await fetch(atestadosApiUrl, { headers: authHeaders });
                if (!response.ok) throw new Error('Falha ao buscar atestados');
                const atestados = await response.json();
                listaAtestados.innerHTML = '';

                if (atestados.length === 0) {
                    listaAtestados.innerHTML = '<p>Nenhum atestado emitido para este paciente.</p>';
                } else {
                    atestados.forEach(atestado => {
                        const dataEmissao = new Date(atestado.data_emissao).toLocaleString('pt-BR');
                        const divAtestado = document.createElement('div');
                        divAtestado.classList.add('evolucao'); // Reutilizando estilo
                        divAtestado.innerHTML = `
                            <div class="evolucao-meta">
                                <strong>Data:</strong> ${dataEmissao} | <strong>Médico:</strong> ${atestado.medico}
                            </div>
                            <p><strong>Tipo:</strong> ${atestado.tipo_atestado_display}</p>
                            <p><strong>Texto:</strong><br>${atestado.observacoes.replace(/\n/g, '<br>')}</p>
                        `;
                        listaAtestados.appendChild(divAtestado);
                    });
                }
            } catch (error) {
                console.error('Erro ao buscar atestados:', error);
                listaAtestados.innerHTML = '<p>Erro ao carregar histórico de atestados.</p>';
            }
        }
        formAtestado.addEventListener('submit', async (event) => {
            event.preventDefault();
            const atestadoData = {
                tipo_atestado: document.getElementById('tipo_atestado').value,
                observacoes: document.getElementById('observacoes').value,
            };

            if (!atestadoData.tipo_atestado) {
                alert('Por favor, selecione um tipo de atestado.');
                return;
            }

            try {
                const response = await fetch(atestadosApiUrl, {
                    method: 'POST',
                    headers: authHeaders,
                    body: JSON.stringify(atestadoData)
                });
                if (!response.ok) throw new Error('Falha ao gerar atestado');
                
                alert('Atestado gerado com sucesso!');
                formAtestado.reset();
                buscarAtestados(); // Atualiza a lista
            } catch (error) {
                console.error('Erro ao gerar atestado:', error);
                alert('Erro ao gerar atestado.');
            }
        });

        // --- 3. EVENT LISTENERS ---
        btnEditarAnamnese.addEventListener('click', () => {
            renderizarFormularioAnamnese(dadosAnamneseCache);
        });

        formAnamnese.addEventListener('submit', async (event) => {
            event.preventDefault();
            const campos = [];
            formAnamnese.querySelectorAll('textarea').forEach(textarea => {
                campos.push({ campo: textarea.dataset.campoNome, valor: textarea.value });
            });
            const method = anamneseExistente ? 'PUT' : 'POST';
            try {
                const response = await fetch(anamneseApiUrl, { method, headers: authHeaders, body: JSON.stringify({ campos }) });
                if (!response.ok) throw new Error('Falha ao salvar anamnese');
                alert('Anamnese salva com sucesso!');
                buscarAnamnese();
            } catch (error) { alert('Erro ao salvar anamnese.'); }
        });
        
        formEvolucao.addEventListener('submit', async (event) => {
            event.preventDefault();
            const evolucaoData = {
                paciente_id: pacienteId,
                notas_subjetivas: document.getElementById('notas_subjetivas').value,
                notas_objetivas: document.getElementById('notas_objetivas').value,
                avaliacao: document.getElementById('avaliacao').value,
                plano: document.getElementById('plano').value,
            };
            try {
                const response = await fetch(evolucoesApiUrl, { method: 'POST', headers: authHeaders, body: JSON.stringify(evolucaoData) });
                if (!response.ok) throw new Error('Falha ao salvar');
                formEvolucao.reset();
                buscarEvolucoes();
            } catch (error) { alert('Erro ao salvar evolução.'); }
        });
        
        addMedicamentoBtn.addEventListener('click', adicionarMedicamento);
        
        formPrescricao.addEventListener('submit', async (event) => {
            event.preventDefault();
            const itens = [];
            medicamentosContainer.querySelectorAll('.medicamento-item').forEach(item => {
                const nome = item.querySelector('.medicamento-nome').value;
                if(nome) { // Só adiciona se o nome do medicamento for preenchido
                    itens.push({
                        medicamento: nome,
                        dosagem: item.querySelector('.medicamento-dosagem').value,
                        instrucoes: item.querySelector('.medicamento-instrucoes').value,
                    });
                }
            });
            if (itens.length === 0) {
                alert('Adicione pelo menos um medicamento.'); return;
            }
            try {
                await fetch(prescricoesApiUrl, { method: 'POST', headers: authHeaders, body: JSON.stringify({ itens }) });
                alert('Prescrição salva com sucesso!');
                medicamentosContainer.innerHTML = '';
                adicionarMedicamento();
                buscarPrescricoes();
            } catch (error) { alert('Erro ao salvar prescrição.'); }
        });

        document.getElementById('logout-button').addEventListener('click', () => {
            localStorage.removeItem('authToken');
            window.location.href = 'login.html';
        });

        // --- 4. INICIALIZAÇÃO DA PÁGINA ---
        async function init() {
            await buscarDetalhesPaciente();
            await buscarAnamnese();
            await buscarEvolucoes();
            await buscarPrescricoes();
            adicionarMedicamento();
            await buscarAtestados();
        }
        init();
    </script>
</body>
</html>