{"ast":null,"code":"// src/components/dicom/DicomViewer.jsx\nimport React,{useEffect,useRef,useState}from'react';import{Box,Typography,CircularProgress,IconButton,Alert}from'@mui/material';import CloseIcon from'@mui/icons-material/Close';// Importações do Cornerstone\nimport cornerstone from'cornerstone-core';import cornerstoneWADOImageLoader from'cornerstone-wado-image-loader';import dicomParser from'dicom-parser';// Configuração inicial do Cornerstone\nimport{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";try{cornerstoneWADOImageLoader.external.cornerstone=cornerstone;cornerstoneWADOImageLoader.external.dicomParser=dicomParser;cornerstoneWADOImageLoader.configure({beforeSend:function(xhr){// Configurações futuras de autenticação podem ir aqui\n}});}catch(error){console.error(\"Erro ao configurar o cornerstoneWADOImageLoader:\",error);}export default function DicomViewer(_ref){let{exame,onClose}=_ref;const elementRef=useRef(null);const[isLoading,setIsLoading]=useState(true);const[error,setError]=useState(null);useEffect(()=>{const element=elementRef.current;if(!element||!exame)return;// Coloque a URL base do seu servidor Orthanc aqui.\n// Em um projeto real, isso viria de uma variável de ambiente (.env).\nconst orthancBaseUrl='http://localhost:8042';const loadImage=async()=>{setIsLoading(true);setError(null);try{var _studyData$Series,_studyData$Series$,_studyData$Series$$In;// --- INÍCIO DA LÓGICA PRINCIPAL ---\n// 1. Buscar os detalhes do estudo na API do Orthanc\nconst studyResponse=await fetch(\"\".concat(orthancBaseUrl,\"/studies/\").concat(exame.orthanc_study_id));if(!studyResponse.ok){throw new Error(\"Falha ao buscar detalhes do estudo no Orthanc: \".concat(studyResponse.statusText));}const studyData=await studyResponse.json();// 2. Extrair o ID da primeira imagem (instância) do estudo.\n// A estrutura é: Estudo -> contém Séries -> que contêm Instâncias\nconst firstInstanceId=studyData===null||studyData===void 0?void 0:(_studyData$Series=studyData.Series)===null||_studyData$Series===void 0?void 0:(_studyData$Series$=_studyData$Series[0])===null||_studyData$Series$===void 0?void 0:(_studyData$Series$$In=_studyData$Series$.Instances)===null||_studyData$Series$$In===void 0?void 0:_studyData$Series$$In[0];if(!firstInstanceId){throw new Error(\"Nenhuma imagem (instância) foi encontrada neste estudo DICOM.\");}// 3. Construir a URL final que o Cornerstone entende (WADO-URI)\n// Esta URL aponta diretamente para o arquivo da imagem DICOM.\nconst imageId=\"wadouri:\".concat(orthancBaseUrl,\"/instances/\").concat(firstInstanceId,\"/file\");// 4. Habilitar o elemento HTML e pedir ao Cornerstone para carregar e exibir a imagem.\ncornerstone.enable(element);const image=await cornerstone.loadImage(imageId);cornerstone.displayImage(element,image);// --- FIM DA LÓGICA PRINCIPAL ---\n}catch(err){console.error('Erro detalhado ao carregar imagem DICOM:',err);setError(err.message);}finally{setIsLoading(false);}};loadImage();// Função de limpeza: desabilita o elemento quando o componente for desmontado.\nreturn()=>{if(element){try{cornerstone.disable(element);}catch(e){/* ignora erro se já desabilitado */}}};},[exame]);return/*#__PURE__*/_jsxs(Box,{sx:{p:2,position:'relative'},children:[/*#__PURE__*/_jsx(IconButton,{onClick:onClose,sx:{position:'absolute',top:8,right:8,zIndex:1,color:'white',backgroundColor:'rgba(0,0,0,0.5)'},children:/*#__PURE__*/_jsx(CloseIcon,{})}),/*#__PURE__*/_jsx(Typography,{variant:\"h6\",sx:{mb:1},children:exame===null||exame===void 0?void 0:exame.study_description}),/*#__PURE__*/_jsxs(Box,{sx:{width:'100%',height:'512px',backgroundColor:'black',color:'white',display:'flex',justifyContent:'center',alignItems:'center',position:'relative'// Para posicionar o conteúdo interno\n},children:[/*#__PURE__*/_jsx(\"div\",{ref:elementRef,style:{width:'100%',height:'100%',position:'absolute'}}),isLoading&&/*#__PURE__*/_jsx(CircularProgress,{color:\"inherit\"}),error&&/*#__PURE__*/_jsx(Alert,{severity:\"error\",sx:{width:'100%'},children:error})]})]});}","map":{"version":3,"names":["React","useEffect","useRef","useState","Box","Typography","CircularProgress","IconButton","Alert","CloseIcon","cornerstone","cornerstoneWADOImageLoader","dicomParser","jsx","_jsx","jsxs","_jsxs","external","configure","beforeSend","xhr","error","console","DicomViewer","_ref","exame","onClose","elementRef","isLoading","setIsLoading","setError","element","current","orthancBaseUrl","loadImage","_studyData$Series","_studyData$Series$","_studyData$Series$$In","studyResponse","fetch","concat","orthanc_study_id","ok","Error","statusText","studyData","json","firstInstanceId","Series","Instances","imageId","enable","image","displayImage","err","message","disable","e","sx","p","position","children","onClick","top","right","zIndex","color","backgroundColor","variant","mb","study_description","width","height","display","justifyContent","alignItems","ref","style","severity"],"sources":["/Users/macmini/Documents/Sistema_Consultorio/frontend/src/components/dicom/DicomViewer.jsx"],"sourcesContent":["// src/components/dicom/DicomViewer.jsx\n\nimport React, { useEffect, useRef, useState } from 'react';\nimport { Box, Typography, CircularProgress, IconButton, Alert } from '@mui/material';\nimport CloseIcon from '@mui/icons-material/Close';\n\n// Importações do Cornerstone\nimport cornerstone from 'cornerstone-core';\nimport cornerstoneWADOImageLoader from 'cornerstone-wado-image-loader';\nimport dicomParser from 'dicom-parser';\n\n// Configuração inicial do Cornerstone\ntry {\n  cornerstoneWADOImageLoader.external.cornerstone = cornerstone;\n  cornerstoneWADOImageLoader.external.dicomParser = dicomParser;\n  cornerstoneWADOImageLoader.configure({\n    beforeSend: function(xhr) {\n      // Configurações futuras de autenticação podem ir aqui\n    }\n  });\n} catch (error) {\n  console.error(\"Erro ao configurar o cornerstoneWADOImageLoader:\", error);\n}\n\n\nexport default function DicomViewer({ exame, onClose }) {\n  const elementRef = useRef(null);\n  const [isLoading, setIsLoading] = useState(true);\n  const [error, setError] = useState(null);\n\n  useEffect(() => {\n    const element = elementRef.current;\n    if (!element || !exame) return;\n\n    // Coloque a URL base do seu servidor Orthanc aqui.\n    // Em um projeto real, isso viria de uma variável de ambiente (.env).\n    const orthancBaseUrl = 'http://localhost:8042';\n\n    const loadImage = async () => {\n      setIsLoading(true);\n      setError(null);\n      try {\n        // --- INÍCIO DA LÓGICA PRINCIPAL ---\n\n        // 1. Buscar os detalhes do estudo na API do Orthanc\n        const studyResponse = await fetch(`${orthancBaseUrl}/studies/${exame.orthanc_study_id}`);\n        if (!studyResponse.ok) {\n          throw new Error(`Falha ao buscar detalhes do estudo no Orthanc: ${studyResponse.statusText}`);\n        }\n        const studyData = await studyResponse.json();\n\n        // 2. Extrair o ID da primeira imagem (instância) do estudo.\n        // A estrutura é: Estudo -> contém Séries -> que contêm Instâncias\n        const firstInstanceId = studyData?.Series?.[0]?.Instances?.[0];\n\n        if (!firstInstanceId) {\n          throw new Error(\"Nenhuma imagem (instância) foi encontrada neste estudo DICOM.\");\n        }\n\n        // 3. Construir a URL final que o Cornerstone entende (WADO-URI)\n        // Esta URL aponta diretamente para o arquivo da imagem DICOM.\n        const imageId = `wadouri:${orthancBaseUrl}/instances/${firstInstanceId}/file`;\n\n        // 4. Habilitar o elemento HTML e pedir ao Cornerstone para carregar e exibir a imagem.\n        cornerstone.enable(element);\n        const image = await cornerstone.loadImage(imageId);\n        cornerstone.displayImage(element, image);\n\n        // --- FIM DA LÓGICA PRINCIPAL ---\n\n      } catch (err) {\n        console.error('Erro detalhado ao carregar imagem DICOM:', err);\n        setError(err.message);\n      } finally {\n        setIsLoading(false);\n      }\n    };\n\n    loadImage();\n\n    // Função de limpeza: desabilita o elemento quando o componente for desmontado.\n    return () => {\n      if (element) {\n        try { cornerstone.disable(element); } catch(e) { /* ignora erro se já desabilitado */ }\n      }\n    };\n  }, [exame]);\n\n\n  return (\n    <Box sx={{ p: 2, position: 'relative' }}>\n        <IconButton\n            onClick={onClose}\n            sx={{ position: 'absolute', top: 8, right: 8, zIndex: 1, color: 'white', backgroundColor: 'rgba(0,0,0,0.5)' }}\n        >\n            <CloseIcon />\n        </IconButton>\n        <Typography variant=\"h6\" sx={{ mb:1 }}>\n            {exame?.study_description}\n        </Typography>\n        <Box \n            sx={{\n                width: '100%',\n                height: '512px',\n                backgroundColor: 'black',\n                color: 'white',\n                display: 'flex',\n                justifyContent: 'center',\n                alignItems: 'center',\n                position: 'relative' // Para posicionar o conteúdo interno\n            }}\n        >\n            {/* O ref é para o cornerstone saber onde desenhar a imagem */}\n            <div ref={elementRef} style={{width: '100%', height: '100%', position: 'absolute'}} />\n            \n            {/* Mensagens de estado para o usuário */}\n            {isLoading && <CircularProgress color=\"inherit\" />}\n            {error && <Alert severity=\"error\" sx={{width: '100%'}}>{error}</Alert>}\n        </Box>\n    </Box>\n  );\n}"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}